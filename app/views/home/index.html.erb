<h1>Your Tasks</h1>
<% theme_code = @current_user.nil? ? "a" : @current_user.theme.code %>
<% anonymize = false %>
<p><%= t 'home.greeting', name: @first_name %>,</br>
  <% tasks = @waiting_student_tasks + @waiting_instructor_tasks %>
  <%= t 'home.tasks', count: tasks.count %></p>
<div data-role="tabs" id="tabs">
  <div data-role="navbar">
    <ul>
      <li><a href="#weekly" data-ajax="false">Week View</a></li>
      <li><a href="#tasks" data-ajax="false">Task View</a></li>
      <li><a href="#monthly" data-ajax="false">Month View</a></li>
    </ul>
  </div>
  <div id="tasks" class="ui-body-<%= theme_code %> ui-content">
    <h3>Task List</h3>
<% if @waiting_instructor_tasks.any? %>
<h4><%= t :instructor_tasks %></h4>
  <table data-role="table"
          id="basicTable"
          data-column-btn-theme"<%= theme_code %>" 
          data-column-popup-theme="<%= theme_code %>" 
          data-mode="columntoggle"
          data-column-btn-theme="<%= theme_code %>" 
          data-column-btn-text="<%= t :column_select %>"
          class="table-stroke ui-shadow table-stripe table-ui-responsive ">
    <thead>
      <tr>
        <th><%= t :task_name %></th>
        <th data-priority="1"><%= t 'home.task_type' %></th>
        <th data-priority="0"><%= t :status %></th>
        <th data-priority="1"><%= t :course_name %></th>
        <th data-priority="0"><%= t :close_date %></th>
      </tr>
    </thead>
    <tbody>
    <% @waiting_instructor_tasks.each do |task| %>
      <tr>
        <td data-priority="0"><%= link_to "Review: " + task.get_name( anonymize ), review_bingo_candidates_path( task )%> </td>
        <td align="center" data-priority="1">Bingo! Candidate Review</td>
        <td align="center" data-priority="1"><%= task.status %>%</td>
        <td data-priority="1"><%= task.course.get_name( anonymize ) %></td>
        <td data-priority="0"><<%= task.end_date.in_time_zone( @current_user.timezone ).strftime( "%a, %b %-d at %-l:%M%P %Z") %></td>
      </tr>
    <% end %>
    </tbody>
  </table>
<% end %>
</br>
<% if @waiting_student_tasks.any? %>
<h4><%= t :student_tasks %></h4>
  <table data-role="table"
          id="basicTable"
          data-column-btn-theme"<%= theme_code %>" 
          data-column-popup-theme="<%= theme_code %>" 
          data-mode="columntoggle"
          data-column-btn-theme="<%= theme_code %>" 
          data-column-btn-text="<%= t :column_select %>"
          class="table-stroke ui-shadow table-stripe table-ui-responsive ">
    <thead>
      <tr>
        <th><%= t :task_name %></th>
        <th data-priority="1"><%= t 'home.task_type' %></th>
        <th><%= t :status %></th>
        <th data-priority="1"><%= t :group %></th>
        <th data-priority="0"><%= t :course_name %></th>
        <th data-priority="1"><%= t :open_date %></th>
        <th data-priority="0"><%= t :close_date %></th>
        <th data-priority="1"><%= t :consent_form %></th>
      </tr>
    </thead>
    <tbody>
      <% @waiting_student_tasks.each do |task| %>
        <% if task.class == Assessment %>
          <% group = task.group_for_user( @current_user )%>
          <tr>
            <td>
              <% if(task.is_completed_by_user @current_user) %>
                <%= link_to group.get_name( anonymize ), edit_installment_path( :assessment_id => task.id, :group_id => group.id ) %>
                <br>
                (<%= t :project %>: <%= task.project.get_name( anonymize ) %>)
                  <% else %>
                <%= link_to group.get_name( anonymize ), new_installment_path( :assessment_id => task.id, :group_id => group.id ) %>
                <br>
                (<%= t :project %>: <%= task.project.get_name( anonymize ) %>)
                  <% end %>
            </td>
            <td><%= t 'home.sapa' %></td>
            <td>
              <% if(task.is_completed_by_user @current_user) %>
                <em><%= t :complete %></em>
              <% else %>
                <em><%= t :not_started %></em>
              <% end %>
            </td>
            <td> <%= group.get_name( anonymize ) %></td>
            <td> <%= task.project.course.get_name( anonymize ) %></td>
            <td> <%= task.start_date.in_time_zone( @current_user.timezone ).strftime( "%a, %b %-d at %-l:%M%P %Z") %> </td>
            <td> <%= task.end_date.in_time_zone( @current_user.timezone ).strftime( "%a, %b %-d at %-l:%M%P %Z") %> </td>
            <td>
              <%= render :partial => "shared/consent", :locals => { :project => task.project } %>
            </td>
          </tr>
        <% elsif task.class == BingoGame %>
          <tr><% candidate_list = task.candidate_list_for_user( @current_user ) %>
            <% if task.is_open? %>
              <td>
                <%= link_to task.get_name( anonymize ), edit_candidate_list_path( candidate_list ) %>
              </td>
              <td><%= t 'candidates.submission' %></td>
              <td>
                <%= candidate_list.percent_completed %>%
              </td>
            <% elsif task.reviewed %>
              <td>
                <%= link_to task.get_name( anonymize ), candidate_list_path( candidate_list ) %>
              </td>
              <td><%= t 'candidates.distilled' %></td>
              <td>
                <%= task.concepts.count %> concepts
              </td>
            <% end %>
            <td>
              <% if task.project.present? && task.project.group_for_user( @current_user ) %>
                <%= task.project.group_for_user( @current_user ).get_name( anonymize ) %>
              <% else %>
                N/A
              <% end %>
            </td>
            <td> <%= task.course.get_name( anonymize ) %></td>
            <td> <%= task.start_date.in_time_zone( @current_user.timezone ).strftime( "%a, %b %-d at %-l:%M%P %Z") %> </td>
            <td>
              <%= task.term_list_date.in_time_zone( @current_user.timezone ).strftime( "%a, %b %-d at %-l:%M%P %Z") %></br>
              <small><i>(<%= t 'candidates.list_for_class' %> <%= task.end_date.in_time_zone( @current_user.timezone ).strftime( "%a, %b %-d") %></i></small>)
            </td>
            <td>N/A</td>
          </tr>
        <% else %>
          <tr>
            <td>
              <% reaction = task.get_user_reaction( @current_user ) %>
              <% if reaction.behavior.present? %>
                <%= task.get_name( anonymize ) %>
              <% else %>
                <%= link_to task.get_name( anonymize ), next_experience_path( :experience_id => task.id ) %>
              <% end %>
            </td>
            <td><%= t 'experience.simulation' %></td>
            <td>
              <em>
                <%= reaction.status %>
              </em>
            </td>
            <td> N/A</td>
            <td> <%= task.course.get_name( anonymize ) %></td>
            <td> <%= task.start_date.in_time_zone( @current_user.timezone ).strftime( "%a, %b %-d at %-l:%M%P %Z") %> </td>
            <td> <%= task.end_date.in_time_zone( @current_user.timezone ).strftime( "%a, %b %-d at %-l:%M%P %Z") %> </td>
            <td>
              <%= t :n_a %>
                </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
<% end %>
</div>
  <div id="weekly" class="ui-body-<%= theme_code %> ui-content">
    <h3>Month View</h3>
    <%= week_calendar attribute: :start_date, events: tasks,  number_of_weeks: 2 do |date,meetings| %>
      <%= date %>
      <%= meetings.each do |meeting| %>
        <div>
          <%= render :partial => "shared/task_link", 
                    :locals => { :task => meeting, :anonymize => anonymize, :user => @current_user } %>
        </div>
      <% end %>
    <% end %>
  </div>
  <div id="monthly" class="ui-body-<%= theme_code %> ui-content">
    <h3>Month View</h3>
    <%= month_calendar attribute: :start_date, events: tasks  do |date,meetings| %>
      <%= date %>
      <%= meetings.each do |meeting| %>
        <div>
          <%= render :partial => "shared/task_link", 
                    :locals => { :task => meeting, :anonymize => anonymize, :user => @current_user } %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
